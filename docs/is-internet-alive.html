<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="Igor Rosenberg">
    <link rel="icon" href="../../favicon.ico">

    <title>cors</title>

<style>  
  div { border: 1px solid grey; margin:10px; padding:5px;}
  #data_zone p, #insert_zone p { display: inline; padding:5px;}
  input[type=text] { width: 80%; }
  div.icon {width: 100px; height: 100px;}
  .spinner {background-image: url("images/spinner.gif"); background-position: center; background-size:auto; background-repeat: no-repeat;}
  .icon.ok {background-image: url("images/green-tick.svg");}
  .icon.ko {background-image: url("images/red-cross.svg");}

canvas {
  margin: 5px;
  border: 1px solid orange;
}
#log {font-size:70%; background-color:#C0C0C0;}
table { width:100%; }
td { vertical-align: top; }
#td1 {width: 45%;}
#td2 {width: 25%;}
#td3 {width: 25%;}

</style>  
</head>

<body role="document">

<h1>Is internet alive?</h1>

<h4>Control zone</h4>
<div id="control">
   <input id="url" type=text value="http://html5rocks-cors.s3-website-us-east-1.amazonaws.com/index.html">
   <br/>
   Auto: 
   <input type="radio" value="Y" name="auto" autocomplete="off">On
   <input type="radio" value="N" name="auto" checked="checked" autocomplete="off">Off
	<button id="corsButton">Is internet alive?</button>
	<button id="demoPast">Past demo</button>
</div>

<h4>Date zone</h4>
<table>
  <tr>
  <td id='td1'></td>
  <td id='td2'>
    <div id='log'>
       <p><b>Log</b></p>
    </div> 
  </td>
  <td id='td3'>
    <div class='icon spinner'></div> 
  </td>
  </tr>
</table></div> 


    <!-- ================================================== -->
    <!-- JavaScript libs placed at the end of the document so the pages load faster -->
    <script src="jquery-3.3.1.min.js"></script>
    <script>window.jQuery || document.write('<div>No Jquery<\/div>')</script>
    <!-- ================================================== -->
    <!-- specific JavaScript  -->
    <script>

$( document ).ready(function() {

  var counter = 1; 

  var my_log = function(s){
    return;
    $("#log").append('<p>['+(	counter++)+'] ' + s+'</p>');
  }

  var done = function (data, textStatus, jqXHR){
    my_log('done: ' + data.length);
    $('div.icon').removeClass('ko').addClass('ok');
  };
  var fail = function(jqXHR, textStatus, errorThrown){
    my_log('fail: ' + textStatus + '/' + errorThrown);
    $('div.icon').removeClass('ok').addClass('ko');
  };
  var check = function(){
    var url = $('#url').val();
    my_log("url: " + url);
    $.get({url:url, cache:false, timeout: 1000}).done(done).fail(fail);
    };
  var autoCheck = function(){
   if ($('input[name=auto]:checked').val() === 'Y')
      check();
   else 
      my_log('disabled');   
   setTimeout(autoCheck, 2000);
  };

  autoCheck();
  $('#corsButton').on('click', check);
  $('#url').on('input', check);
});  
</script>


<script>
var log = function(s) {
  var zone = document.getElementById("log");
  zone.append(s);
};

var progress = (function() {
  var scale = 5;

  var black = "rgba(0,0,0,1)";
  var red = "rgba(255,0,0,1)";
  var green = "rgba(0,255,0,1)";
  var blue = "rgba(0,0,255,1)";
  var colors = [black, red, green, blue];

  var getContext = function(id) {
    log("get " );
    var canvas = document.createElement("canvas"); 
    canvas.setAttribute("width", "500");
    canvas.setAttribute("height", "80");  
    var td = document.getElementById("td1");
    td.insertBefore(canvas, td.firstChild);    
    var context = canvas.getContext("2d");
    context.font = "10px serif";
    context.translate(20, 0);
    return context;  
  };

  var context;

  var pixel = function(color, x, y) {
    // log("px. ");
    context.fillStyle = color;
    context.fillRect(x * scale, y * scale, scale - 1, scale - 1);
  };

  var oblique = function(text, xPos, yPos) {
    log("oblique. ");
    context.save();
    context.translate((xPos - 1) * scale, yPos * scale);
    context.rotate(-Math.PI / 4);
    context.fillStyle = black;
    context.textAlign = "right";
    context.fillText(text, 0, 3 * scale);
    context.restore();
  };

  var toX = function(time) {
    var mod = time % 10;
    var x = (time - mod) / 10;
    return x + Math.floor(time / 60); // add an x-space every 60 hits
  };

  var toY = function(time) {
    var mod = time % 10;
    return 10 - mod;
  };

  function dateToString(d) {
    d = d || new Date();
    return (
      // + ("0" + d.getHours()).slice(-2) + ":"
      +("0" + d.getMinutes()).slice(-2) +
      ":" +
      ("0" + d.getSeconds()).slice(-2) +
      ":" +
      ("00" + d.getMilliseconds()).slice(-3)
    );
  }

  var getStarter = function() {
    return Math.floor(new Date().getTime() / 1000) * 1000;
  };
  var start;

  //var start =Math.floor(new Date().getTime()/1000) * 1000;

  var last = 0;
  return {
    plotty: function(delay) {
      // var imgData=context.getImageData(0,0,50,100);
      // context.putImageData(imgData,0,0);
      // context.translate(-20, 0);
      if (delay === 65 * 11) {
        this.reset(); 
      } else {
        var x = toX(delay);
        if (delay > last + 60) {
          last = delay;
          var date = dateToString();
          oblique(date, x, 10);
        }
        var y = toY(delay);
        this.withResult(function(colorInt) {
          pixel(colors[colorInt], x, y);
        });
      }
    },
    plot: function() {
      var delay = Math.round((new Date().getTime() - start) / 10);
      this.plotty(delay);
    },
    reset: function(){
        last = 0;
        start = getStarter();
        context = getContext();
    }

  };
})(); // end progress

// sole extension point: what is the current integer result ?
progress.withResult = function(callback) {
  // here, do asyncronous CORS
  var delay = new Date().getTime();
  var color = delay % 37 == 0 ? 0 : delay % 13 == 0 ? 1 : 2;
  callback(color);
};

$('#demoPast').on('click', function(){
progress.reset();
for (var delay1 = 0; delay1 < 5000; delay1++)
  (function(delay) {
    setTimeout(function() {
      var t = delay;
      progress.plot(delay);
    }, delay * 1000 / 10 / 4 / 5);
  })(delay1);
});
</script>
  </body>
</html>
