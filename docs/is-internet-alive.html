<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="Igor Rosenberg">
    <link rel="icon" href="../../favicon.ico">

    <title>cors</title>

<style>  
  div { border: 1px solid grey; margin:10px; padding:5px;}
  #data_zone p, #insert_zone p { display: inline; padding:5px;}
  input[type=text] { width: 80%; }
  div.icon {width: 100px; height: 100px;}
  .spinner {background-image: url("images/spinner.gif"); background-position: center; background-size:auto; background-repeat: no-repeat;}
  .icon.ok {background-image: url("images/green-tick.svg");}
  .icon.ko {background-image: url("images/red-cross.svg");}
</style>  
</head>

<body role="document">

<h1>CORS</h1>

<h4>Control zone</h4>
<div id="control">
   <input id="url" type=text value="http://html5rocks-cors.s3-website-us-east-1.amazonaws.com/index.html">
   <br/>
   Auto: 
   <input type="radio" value="Y" name="auto" autocomplete="off">On
   <input type="radio" value="N" name="auto" checked="checked" autocomplete="off">Off
	<button id="corsButton">Is internet alive?</button>
</div>

<h4>Data zone</h4>
<div class='icon spinner'></div> 
<div id="data_zone">
</div> 

<h4>Status zone</h4>
<div id="status_zone">
<canvas id="canvas" width="500" height="100">
    <p>An HTML5 Canvas is displayed here, showing the chronological trend. </p>
</canvas>
</div> 


    <!-- ================================================== -->
    <!-- JavaScript libs placed at the end of the document so the pages load faster -->
    <script src="jquery-3.3.1.min.js"></script>
    <script>window.jQuery || document.write('<div>No Jquery<\/div>')</script>
    <!-- ================================================== -->
    <!-- specific JavaScript  -->
    <script>

$( document ).ready(function() {

  var counter = 1; 

  var my_log = function(s){
    return;
    $("#data_zone").append('<p>['+(	counter++)+'] ' + s+'</p>');
  }

  var done = function (data, textStatus, jqXHR){
    my_log('done: ' + data.length);
    $('div.icon').removeClass('ko').addClass('ok');
  };
  var fail = function(jqXHR, textStatus, errorThrown){
    my_log('fail: ' + textStatus + '/' + errorThrown);
    $('div.icon').removeClass('ok').addClass('ko');
  };
  var check = function(){
    var url = $('#url').val();
    my_log("url: " + url);
    $.get({url:url, cache:false, timeout: 1000}).done(done).fail(fail);
    };
  var autoCheck = function(){
   if ($('input[name=auto]:checked').val() === 'Y')
      check();
   else 
      my_log('disabled');   
   setTimeout(autoCheck, 2000);
  };

  autoCheck();
  $('#corsButton').on('click', check);
  $('#url').on('input', check);
});  

///////////

var canvas = document.getElementById('canvas'),
    context = canvas.getContext('2d');


context.translate(20, 0);

context.font = '10px serif';

var scale = 5;
var black = "rgba(0,0,0,1)";
var red   = "rgba(255,0,0,1)";
var green = "rgba(0,255,0,1)";

var pixel = function(color, x, y){
  context.fillStyle = color;
  context.fillRect( x*scale, y*scale,
                      scale,scale );
}

var poxel = function(timet, color)
  {
  var time = timet / 10; 
  var mod = time % 10;
  var x = (time - mod) / 10;
  var y = 10 - mod;
    
  var delta = Math.floor(time / 60); // add an x-space every 60 hits
  x += delta;
  context.fillRect( x*scale, y*scale,
                      scale, scale );
}

var oblique = function(text, xPos, yPos){
  context.save();
  context.translate((xPos-1) *scale, yPos*scale);
  context.rotate(-Math.PI / 4);
  context.fillStyle = black;
  context.textAlign = 'right';
  context.fillText(text, 0, 10);
  context.restore();
}

function dateToString(d){
return ( 
    ("0" + d.getHours()).slice(-2) + ":" + 
    ("0" + d.getMinutes()).slice(-2) 
    // + ":" + ("0" + d.getSeconds()).slice(-2) 
   );
}

function point(fakeNow){
  var now = fakeNow;

  if (now > start + 3600)
    return;

  setTimeout(function(){point (now + 10);}, 10); // allow g-refresh in-between

  var delay = (now - start); 
  if (delay % 600 === 0) {
		 var text = dateToString(new Date(now * 1000));
		 oblique(text, (delay / 600)*7, 12);	// 7 = 6 cols + 1 blank
  }
  poxel(delay, color(delay));
}

function color(time){
  if (time %17 == 0)
    context.fillStyle = red;
  else if (time % 13 ==1)
    context.fillStyle = black;
  else
    context.fillStyle = green;
}

var start = Math.floor(new Date().getTime() / 1000); // everything in round seconds

point(start);

    </script>

  </body>
</html>
